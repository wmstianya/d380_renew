# Change: 优化UART4时序控制避免机组断联

**状态**: 🚧 待实现

## Why

当前UART4（联控通信）存在以下问题导致机组断联：

1. **固定100ms轮询间隔**: 无论响应快慢，都等待100ms后才切换下一个分机
2. **双角色冲突**: 主机轮询分机时，可能错过联控主机的请求
3. **无优先级区分**: 从机响应与主机轮询同等处理，联控主机请求可能丢失
4. **高冲突概率**: 约20%的请求可能发生冲突

### 断联场景

```
联控板轮询分机1 → [100ms等待] → 联控主机发送请求
                    ↑
                 此时无法响应，联控主机判定联控板离线
```

## What Changes

### 1. 启用动态间隔 (核心优化)

将 `pollIntervalMs` 从 `100` 改为 `0`：
- 收到响应立即切换下一个分机
- 超时时才等待完整超时时间
- 轮询周期从1000ms降至约150ms

### 2. 缩短超时时间

将 `respTimeoutMs` 从 `100ms` 改为 `50ms`：
- 分机响应通常<10ms
- 缩短超时可更快检测离线

### 3. 添加从机优先级 (可选)

在调度器中优先检查从机请求：
- 每次主机操作前检查是否有联控主机请求
- 有请求时暂停主机轮询，先响应

## Impact

- **Affected files**:
  - `HARDWARE/modbus/modbus_uart4.c` - 修改配置参数

- **预期收益**:

| 指标 | 当前 | 优化后 | 改进 |
|------|------|--------|------|
| 轮询周期 | 1000ms | ~150ms | **6x faster** |
| 联控主机响应延迟 | 0-100ms | <15ms | **>6x** |
| 冲突概率 | ~20% | <2% | **-90%** |
| 机组断联风险 | 高 | 低 | **显著降低** |

## 风险与注意事项

1. **通信负载增加**: 动态间隔会增加通信频率，需确保分机能承受
2. **测试验证**: 需在实际设备上验证断联问题是否解决
3. **回退方案**: 如有问题可将 `pollIntervalMs` 改回100


# 系统通信架构图

## 完整拓扑结构

```
                          ┌────────────────────┐
                          │   RTU客户端/调试    │
                          │   (地址254/可配置)  │
                          └─────────┬──────────┘
                                    │ USART1 (9600)
                                    │ 从机模式
                                    ▼
┌────────────────┐     USART2      ┌──────────────────────┐
│  10.1寸触摸屏   │◀───(115200)───▶│                      │
│  (ModBus主机)  │     从机模式     │      联 控 板        │
└────────────────┘                 │    (本控制板)        │
                                   │                      │
                                   │  地址: Sys_Admin.    │
                                   │  ModBus_Address      │
                                   └───┬──────────┬───────┘
                                       │          │
                              USART3   │          │ UART4
                              (9600)   │          │ (9600)
                              主机模式  │          │ 双角色
                                       │          │
                                       ▼          ▼
                          ┌────────────┐    ┌──────────────┐
                          │ 变频供水阀  │    │  联控主机     │
                          │  地址: 8   │    │ (上级控制器)  │
                          └────────────┘    └──────┬───────┘
                                                   │
                                            UART4 (从机响应)
                                                   │
                          ┌────────────────────────┼────────────────────────┐
                          │                        │                        │
                          ▼                        ▼                        ▼
                    ┌──────────┐            ┌──────────┐            ┌──────────┐
                    │  分机 1   │            │  分机 2   │    ...    │  分机 10  │
                    │ 地址: 1  │            │ 地址: 2  │            │ 地址: 10 │
                    └──────────┘            └──────────┘            └──────────┘
                          ▲                        ▲                        ▲
                          │                        │                        │
                          └────────────────────────┼────────────────────────┘
                                                   │
                                            UART4 (主机轮询)
```

---

## 串口角色汇总

| 串口 | 波特率 | 角色 | 通信对象 | 数据流向 |
|------|--------|------|----------|----------|
| **USART1** | 9600 | 从机 | RTU客户端 | 被动响应查询 |
| **USART2** | 115200 | 从机 | 10.1寸屏 | 被动响应查询 |
| **USART3** | 9600 | 主机 | 变频供水阀 | 主动轮询 |
| **UART4** | 9600 | 双角色 | 联控主机/分机 | 双向 |

---

## 数据流向详解

### 1. 屏幕通信流 (USART2)

```
屏幕 ──请求──▶ 联控板 ──响应──▶ 屏幕
       │                         ▲
       │    ┌────────────────────┘
       │    │
       ▼    │
  ┌─────────┴─────────┐
  │ 读取:              │
  │ - 联控主数据       │
  │ - 机组1-10数据     │
  │                   │
  │ 写入:              │
  │ - 启停控制        │
  │ - PID参数         │
  │ - 压力设置        │
  └───────────────────┘
```

### 2. 分机轮询流 (UART4 主机)

```
联控板 ──03读取──▶ 分机N ──状态数据──▶ 联控板
   │                                      │
   └──10写入──▶ 分机N ──确认──────────────┘
   
轮询顺序: 1 → 2 → 3 → 4 → 5 → 1 ...
每分机: 读取 ↔ 写入 交替
周期: 100ms/分机
```

### 3. 联控主机响应流 (UART4 从机)

```
联控主机 ──03读取──▶ 本控制板 ──状态数据──▶ 联控主机
    │                                           │
    └──10写入──▶ 本控制板 ──确认────────────────┘
```

### 4. 供水阀控制流 (USART3)

```
联控板 ──03读取──▶ 供水阀 ──故障状态──▶ 联控板
   │                                      │
   └──06写入──▶ 供水阀 ──确认─────────────┘

轮询比例: 5次写入 : 1次读取
周期: 200ms
```

---

## 数据同步关系

```
                     ┌─────────────────┐
                     │     屏幕        │
                     │ (USART2 读取)   │
                     └────────┬────────┘
                              │ 读取
                              ▼
┌─────────────────────────────────────────────────────┐
│                      联控板内存                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │  UnionLCD   │  │   JiZu[1]   │  │   JiZu[10]  │  │
│  │  联控数据    │  │   机组1     │  │   机组10    │  │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  │
│         │                │                │         │
│         │    ┌───────────┴────────────────┘         │
│         │    │                                      │
└─────────┼────┼──────────────────────────────────────┘
          │    │
          │    │ UART4 轮询更新
          │    ▼
          │  ┌─────────────────────────────────────┐
          │  │           分机 1 ~ 10               │
          │  └─────────────────────────────────────┘
          │
          │ USART1 读取
          ▼
     ┌─────────────┐
     │ RTU客户端   │
     └─────────────┘
```

---

## 优先级设计

| 优先级 | 串口 | 原因 |
|--------|------|------|
| **0 (最高)** | UART4 | 分机控制实时性要求高 |
| **1** | USART3 | 供水阀控制 |
| **2** | USART2 | 屏幕显示 |
| **3 (最低)** | USART1 | 调试/监控 |

---

## 故障检测机制

| 串口 | 超时阈值 | 故障处理 |
|------|----------|----------|
| USART2 | 无 | 屏幕自行显示通讯故障 |
| USART3 | 10次 | Error19_SupplyWater_UNtalk |
| UART4 (主机) | 20次 | 标记分机离线 |
| UART4 (从机) | 无 | 无 |


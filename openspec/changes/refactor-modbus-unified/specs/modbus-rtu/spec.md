## ADDED Requirements

### Requirement: 统一ModBus RTU协议层

系统SHALL提供统一的ModBus RTU协议处理模块，支持主机和从机两种角色。

#### Scenario: 模块初始化

- **WHEN** 初始化ModBus句柄
- **THEN** 配置绑定的UART句柄、从机地址、角色（主机/从机）
- **AND** 注册寄存器读写回调函数

#### Scenario: 从机接收处理

- **WHEN** 从机收到ModBus请求帧
- **THEN** 校验CRC16
- **AND** 解析功能码和寄存器地址
- **AND** 调用对应的回调函数处理
- **AND** 构建并发送响应帧

#### Scenario: 主机发送请求

- **WHEN** 主机需要读取从机数据
- **THEN** 构建功能码03请求帧
- **AND** 通过DMA发送
- **AND** 等待响应或超时

### Requirement: 主从角色支持

系统SHALL支持同一串口在主机和从机角色之间切换。

#### Scenario: UART4双角色

- **WHEN** 系统作为联控板
- **THEN** UART4对上级联控主机为从机
- **AND** UART4对下级分机为主机
- **AND** 支持动态角色切换

### Requirement: 寄存器地址映射

系统SHALL维护统一的寄存器地址映射表。

#### Scenario: 寄存器读取

- **WHEN** 收到功能码03读取请求
- **THEN** 根据寄存器地址查找对应的数据源
- **AND** 返回请求长度的数据

#### Scenario: 寄存器写入

- **WHEN** 收到功能码10写入请求
- **THEN** 根据寄存器地址写入对应的数据
- **AND** 返回写入确认

## 系统通信架构

```
┌─────────────────────────────────────────────────────────────┐
│                        RTU服务器                            │
│                      (上位机软件)                           │
└─────────────────────┬───────────────────────────────────────┘
                      │ RS485 (USART1)
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│    ┌─────────────┐         ┌─────────────┐                  │
│    │   屏幕      │◀───────▶│  联控板     │                  │
│    │  (主机)     │ USART2  │ (从机)      │                  │
│    └─────────────┘         └──────┬──────┘                  │
│                                   │                         │
│                                   │ UART4 (主机模式)        │
│                                   ▼                         │
│    ┌─────────────────────────────────────────────┐          │
│    │              分机组 1~10                     │          │
│    │  ┌────┐ ┌────┐ ┌────┐ ┌────┐ ... ┌────┐    │          │
│    │  │ 1  │ │ 2  │ │ 3  │ │ 4  │     │ 10 │    │          │
│    │  └────┘ └────┘ └────┘ └────┘     └────┘    │          │
│    └─────────────────────────────────────────────┘          │
│                                                             │
│    ┌─────────────┐                                          │
│    │  从机设备   │◀──── USART3 (主机模式)                   │
│    │ (变频水泵等)│                                          │
│    └─────────────┘                                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 串口角色汇总

| 串口 | 主要角色 | 通信对象 | 备注 |
|------|----------|----------|------|
| USART1 | 从机 | RTU服务器 | 响应上位机查询 |
| USART2 | 从机 | 屏幕 | 响应屏幕轮询 |
| USART3 | 主机 | 从机设备 | 轮询变频水泵等 |
| UART4 | **双角色** | 分机/联控主机 | 主机轮询分机，从机响应联控主机 |

## 待梳理的寄存器地址表

### USART2 寄存器 (屏幕通信)

| 地址 | 长度 | 读/写 | 含义 |
|------|------|-------|------|
| 0x0000 | 48 | R | 联控板主数据 |
| 0x0063 | 19 | R | 机组1数据 |
| 0x0077 | 19 | R | 机组2数据 |
| 0x008B | 19 | R | 机组3数据 |
| 0x009F | 19 | R | 机组4数据 |
| 0x00B3 | 19 | R | 机组5数据 |
| 0x00C7 | 19 | R | 机组6数据 |
| 0x00DB | 19 | R | 机组7数据 |
| 0x00EF | 19 | R | 机组8数据 |
| 0x0103 | 19 | R | 机组9数据 |
| 0x0117 | 19 | R | 机组10数据 |
| 0x0012 | 2 | W | 参数写入 |
| ... | ... | ... | 待补充 |

### UART4 寄存器 (主机轮询分机)

| 地址 | 长度 | 操作 | 含义 |
|------|------|------|------|
| 100 | 18 | 读03 | 读取分机状态 |
| 200 | 18 | 写10 | 写入分机参数 |

### USART1/USART3 寄存器

待梳理...


# USART3 寄存器地址表 (从机设备通信)

## 概述

- **通信对象**: 变频供水阀 (FuNiSen)
- **角色**: ModBus **主机**
- **波特率**: 9600
- **功能码**: 03(读), 06(写单个)

---

## 通信架构

```
┌─────────────┐          ┌─────────────────┐
│   本控制板   │── USART3 ──▶│  变频供水阀    │
│   (主机)    │◀─────────│   地址: 8       │
└─────────────┘          └─────────────────┘
```

---

## 设备信息

| 参数 | 值 |
|------|-----|
| 从机地址 | **8** |
| 使能条件 | `Sys_Admin.Water_BianPin_Enabled` |
| 轮询周期 | 200ms (`sys_flag.WaterAJ_Flag`) |
| 超时检测 | 10次无响应报故障 |

---

## 主机模式寄存器

### 功能码 0x03 - 读取故障状态

**请求帧**:

| 字节 | 值 | 含义 |
|------|-----|------|
| 0 | 0x08 | 从机地址 |
| 1 | 0x03 | 功能码 |
| 2-3 | 0x0000 | 寄存器地址 |
| 4-5 | 0x0001 | 寄存器数量 |
| 6-7 | CRC | 校验 |

**响应解析**:

| 字节偏移 | 值 | 含义 |
|----------|-----|------|
| 0 | 0x08 | 从机地址 |
| 1 | 0x03 | 功能码 |
| 2 | 0x02 | 数据长度 |
| 3-4 | Value | 故障状态 |
| 5-6 | CRC | 校验 |

**故障状态值**:

| 值 | 含义 | 处理 |
|----|------|------|
| **0x00EA** | 故障 | `sys_flag.Error_Code = Error18_SupplyWater_Error` |
| 其他 | 正常 | `sys_flag.Water_Error_Code = 0` |

---

### 功能码 0x06 - 写入开度值

**请求帧**:

| 字节 | 值 | 含义 |
|------|-----|------|
| 0 | 0x08 | 从机地址 |
| 1 | 0x06 | 功能码 |
| 2-3 | 0x0001 | 寄存器地址 |
| 4-5 | Percent | 开度值 (0-1000) |
| 6-7 | CRC | 校验 |

**开度值计算**:

```c
// sys_flag.Water_Percent: 0-100%
// 发送值: Percent * 10 (0-1000)
if (sys_flag.Water_Percent <= 100)
    Percent = sys_flag.Water_Percent * 10;
else
    Percent = 0;  // 值异常则关闭
```

**响应帧** (回显):

| 字节 | 值 | 含义 |
|------|-----|------|
| 0 | 0x08 | 从机地址 |
| 1 | 0x06 | 功能码 |
| 2-3 | 0x0001 | 寄存器地址 |
| 4-5 | Percent | 写入的值 |
| 6-7 | CRC | 校验 |

---

## 寄存器地址汇总

| 地址 | R/W | 数据类型 | 范围 | 含义 |
|------|-----|----------|------|------|
| 0x0000 | R | uint16 | - | 故障状态 (0xEA=故障) |
| 0x0001 | W | uint16 | 0-1000 | 开度值 (百分比×10) |

---

## 轮询时序

```c
// 每5次轮询: 1次读取 + 4次写入
Jump_Count++;
if (Jump_Count > 5) {
    Jump_Index = 0;  // 读取
    Jump_Count = 0;
} else {
    Jump_Index = 1;  // 写入
}
```

**时序图**:

```
T=0ms:    写入开度值
T=200ms:  写入开度值
T=400ms:  写入开度值
T=600ms:  写入开度值
T=800ms:  写入开度值
T=1000ms: 读取故障状态  (每5次)
T=1200ms: 写入开度值
...
```

---

## 故障检测

```c
// 每次发送后 waterSend_Count++
// 收到响应后 waterSend_Count = 0
if (sys_flag.waterSend_Count >= 10) {
    sys_flag.Error_Code = Error19_SupplyWater_UNtalk;
}
```

| 故障代码 | 含义 |
|----------|------|
| **Error18** | 供水设备故障 (0xEA) |
| **Error19** | 供水设备无响应 |

---

## 相关变量

| 变量 | 类型 | 含义 |
|------|------|------|
| `Sys_Admin.Water_BianPin_Enabled` | bool | 变频供水使能 |
| `sys_flag.WaterAJ_Flag` | bool | 200ms轮询标志 |
| `sys_flag.Water_Percent` | uint8 | 目标开度 (0-100%) |
| `sys_flag.waterSend_Flag` | bool | 发送中标志 |
| `sys_flag.waterSend_Count` | uint8 | 超时计数 |
| `sys_flag.Water_Error_Code` | uint8 | 供水故障状态 |

---

## 与其他串口对比

| 特性 | USART3 | UART4 |
|------|--------|-------|
| 角色 | 纯主机 | 双角色 |
| 从机数量 | 1个 (地址8) | 10个 (地址1-10) |
| 功能复杂度 | 简单 (2寄存器) | 复杂 (18寄存器) |
| 轮询周期 | 200ms | 100ms |

---

## 待补充

- [ ] 变频供水阀的完整寄存器手册
- [ ] 其他可能的从机设备扩展


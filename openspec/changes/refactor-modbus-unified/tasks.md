# Tasks: 统一ModBus RTU协议层重构

## Phase 1: 寄存器地址梳理 (前置工作) ✅ 完成

### 1.1 USART1 寄存器梳理 (RTU服务器) ✅
- [x] 1.1.1 分析 `usart.c` 中 `ModBus_Communication()` 的寄存器处理
- [x] 1.1.2 整理功能码03读取的寄存器地址表
  - 地址0: 联控主数据 (11寄存器/22字节)
  - 地址0x0063-0x00C7: 机组1-6数据 (仅1-2启用)
  - 地址1000: 设备地址查询 (特殊)
- [x] 1.1.3 整理功能码06写入的寄存器地址表
  - 0x0000: 联控启停
  - 0x0006: 故障复位
  - 0x0007-0x0009: 压力参数
- [x] 1.1.4 文档化到 `specs/modbus-rtu/usart1-registers.md`

### 1.2 USART2 寄存器梳理 (屏幕通信) ✅
- [x] 1.2.1 分析 `usart2.c` 中 `Union_ModBus2_Communication()` 的寄存器处理
- [x] 1.2.2 整理功能码03读取的寄存器地址表
  - 0x0000: 联控板主数据 (96字节)
  - 0x0063-0x0117: 机组1-10数据 (各38字节)
- [x] 1.2.3 整理功能码10写入的寄存器地址表
  - 联控板模式: 启停控制、PID参数、压力设置等
  - 分机模式: 启停、功率、温度保护等
- [x] 1.2.4 文档化到 `specs/modbus-rtu/usart2-registers.md`

### 1.3 USART3 寄存器梳理 (从机设备通信) ✅
- [x] 1.3.1 分析 `usart3.c` 中ModBus处理逻辑
- [x] 1.3.2 确认主机角色：轮询变频供水阀 (地址8)
- [x] 1.3.3 整理轮询的寄存器地址表
  - 03读取: 地址0x0000, 故障状态
  - 06写入: 地址0x0001, 开度值(0-1000)
- [x] 1.3.4 文档化到 `specs/modbus-rtu/usart3-registers.md`

### 1.4 UART4 寄存器梳理 (联控通信) ✅
- [x] 1.4.1 分析 `usart4.c` 中 `ModBus_Uart4_Local_Communication()` - 从机模式
- [x] 1.4.2 分析 `usart4.c` 中 `Union_Modbus4_UnionTx_Communication()` - 主机模式
- [x] 1.4.3 整理从机模式的寄存器地址表
  - 03响应: 地址100, 返回18寄存器(36字节)本机状态
  - 10处理: 地址0xC8, 接收启停/功率/继电器控制
- [x] 1.4.4 整理主机模式轮询的寄存器地址表
  - 03读取: 地址100, 请求18寄存器
  - 10写入: 地址200, 发送启停/功率/压力参数
- [x] 1.4.5 文档化到 `specs/modbus-rtu/uart4-registers.md`

## Phase 2: 主从角色分析 ✅ 完成

### 2.1 系统通信架构图 ✅
- [x] 2.1.1 绘制完整的系统通信拓扑图
- [x] 2.1.2 标注每个串口的主从角色
- [x] 2.1.3 标注数据流向
- [x] 2.1.4 文档化到 `specs/modbus-rtu/system-architecture.md`

### 2.2 UART4 双角色分析 ✅
- [x] 2.2.1 分析何时作为主机（轮询分机1-5，读写交替）
- [x] 2.2.2 分析何时作为从机（响应联控主机，地址过滤）
- [x] 2.2.3 确认主从切换机制（无显式切换，并行处理，100ms间隔保护）
- [x] 2.2.4 文档化到 `specs/modbus-rtu/uart4-role-switch.md`

## Phase 3: 统一协议层设计

### 3.1 ModBus RTU核心模块
- [ ] 3.1.1 设计 `ModbusHandle` 结构体
- [ ] 3.1.2 设计统一API接口
- [ ] 3.1.3 实现CRC16校验（复用现有）
- [ ] 3.1.4 实现帧解析函数
- [ ] 3.1.5 实现响应构建函数

### 3.2 从机模块
- [ ] 3.2.1 设计从机回调接口
- [ ] 3.2.2 实现功能码03处理框架
- [ ] 3.2.3 实现功能码10处理框架
- [ ] 3.2.4 实现通用响应发送

### 3.3 主机模块
- [ ] 3.3.1 设计主机轮询接口
- [ ] 3.3.2 实现读取请求发送
- [ ] 3.3.3 实现写入请求发送
- [ ] 3.3.4 实现超时和重试机制

## Phase 4: 业务层重构

### 4.1 USART1重构
- [ ] 4.1.1 创建寄存器读写回调
- [ ] 4.1.2 迁移业务逻辑
- [ ] 4.1.3 通信测试验证

### 4.2 USART2重构
- [ ] 4.2.1 创建寄存器读写回调
- [ ] 4.2.2 迁移业务逻辑
- [ ] 4.2.3 与屏幕通信测试验证

### 4.3 USART3重构
- [ ] 4.3.1 创建主机轮询配置
- [ ] 4.3.2 迁移业务逻辑
- [ ] 4.3.3 与从机设备通信测试验证

### 4.4 UART4重构
- [ ] 4.4.1 创建从机寄存器回调
- [ ] 4.4.2 创建主机轮询配置
- [ ] 4.4.3 实现主从角色切换
- [ ] 4.4.4 与分机通信测试验证

## 注意事项

- Phase 1和Phase 2为**前置工作**，必须先完成文档梳理
- 每个Phase完成后需要review和确认
- 重构时保持与现有设备（屏幕、分机）的兼容性
- 建议每重构一个串口就进行完整测试


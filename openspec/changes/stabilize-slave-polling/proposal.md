# 稳定从机轮询并支持可配置轮询数量

## 问题描述

### 问题1: 待机和离线状态频繁切换

当前从机状态不稳定，在待机和离线之间频繁切换。

**根本原因分析**:
1. 超时阈值过于激进: 100ms超时 + 3次重试 = 300ms即判定离线
2. 网络抖动或总线冲突可能导致偶发超时
3. 轮询10台设备时，总线负载较高，可能导致响应延迟

### 问题2: 轮询数量固定

当前固定轮询10台从机，无法根据实际部署调整。

**需求**:
- 支持3台、5台、10台三种配置
- 通过宏定义在编译时选择
- 减少不必要的轮询，降低总线负载

## 解决方案

### 方案1: 增加状态稳定性

1. **增加超时容忍次数**: 从3次增加到5次
2. **添加状态滞后机制**: 离线后需要连续2次成功响应才恢复在线
3. **调整超时时间**: 从100ms增加到150ms

### 方案2: 可配置轮询数量

通过宏定义 `UART4_POLL_COUNT` 配置轮询数量:

```c
/* 在 main.h 中定义 */
#define UART4_POLL_COUNT  3   /* 可选: 3, 5, 10 */
```

## 详细设计

### 状态机优化

```
                    ┌─────────────────┐
                    │   OFFLINE (0)   │
                    └────────┬────────┘
                             │ 连续2次响应成功
                             ▼
                    ┌─────────────────┐
          ┌────────▶│   STANDBY (1)   │◀────────┐
          │         └────────┬────────┘         │
          │                  │                  │
    响应成功              启动命令          停止/故障
          │                  │                  │
          │                  ▼                  │
          │         ┌─────────────────┐         │
          └─────────│   WORKING (2)   │─────────┘
                    └────────┬────────┘
                             │ 连续5次超时
                             ▼
                    ┌─────────────────┐
                    │   OFFLINE (0)   │
                    └─────────────────┘
```

### 新增变量

```c
/* 在 SlaveG 结构中添加 */
uint8_t RecoverCount;  /* 恢复计数: 离线后连续成功响应次数 */
```

### 配置宏定义

```c
/* USER/main.h */

/* 轮询从机数量配置 (可选: 3, 5, 10) */
#ifndef UART4_POLL_COUNT
#define UART4_POLL_COUNT  3
#endif

/* 离线判定超时次数 */
#define UART4_OFFLINE_THRESHOLD  5

/* 恢复在线所需连续成功次数 */
#define UART4_RECOVER_THRESHOLD  2

/* 响应超时时间 (ms) */
#define UART4_RESP_TIMEOUT_MS    150
```

## 预期效果

| 配置 | 单轮时间 (在线) | 单轮时间 (离线) | 离线判定 | 恢复判定 |
|------|-----------------|-----------------|----------|----------|
| 3台  | ~50ms          | 450ms           | 2.25秒   | 100ms    |
| 5台  | ~80ms          | 750ms           | 3.75秒   | 160ms    |
| 10台 | ~150ms         | 1500ms          | 7.5秒    | 300ms    |

## 风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 离线检测变慢 | 故障响应延迟 | 5次×150ms=750ms仍可接受 |
| 恢复滞后 | 用户感知延迟 | 2次成功仅需~50ms |
| 配置错误 | 轮询不到设备 | 提供默认值，编译时检查 |

## 实施文件

1. `USER/main.h`: 添加配置宏定义
2. `HARDWARE/modbus/modbus_uart4.c`: 
   - 使用宏配置轮询数量
   - 实现状态滞后机制
3. `SYSTEM/system_control/system_control.h`: 添加 `RecoverCount` 字段 (如需要)


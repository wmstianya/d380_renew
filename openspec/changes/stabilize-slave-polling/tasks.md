# 任务列表: 稳定从机轮询并支持可配置轮询数量

## 任务1: 添加配置宏定义 [优先级: 高]

**文件**: `USER/main.h`

- [ ] 添加 `UART4_POLL_COUNT` 宏 (默认值3)
- [ ] 添加 `UART4_OFFLINE_THRESHOLD` 宏 (默认值5)
- [ ] 添加 `UART4_RECOVER_THRESHOLD` 宏 (默认值2)
- [ ] 添加 `UART4_RESP_TIMEOUT_MS` 宏 (默认值150)

**验证**: 编译通过，宏值可被引用

---

## 任务2: 修改轮询数量配置 [优先级: 高]

**文件**: `HARDWARE/modbus/modbus_uart4.c`

- [ ] 移除硬编码的 `pollCount = 10`
- [ ] 使用 `UART4_POLL_COUNT` 宏配置轮询数量
- [ ] 使用 `UART4_RESP_TIMEOUT_MS` 宏配置超时时间

**验证**: 修改宏值后轮询数量正确变化

---

## 任务3: 增加离线判定阈值 [优先级: 高]

**文件**: `HARDWARE/modbus/modbus_uart4.c`

- [ ] 修改 `uart4OnTimeout` 使用 `UART4_OFFLINE_THRESHOLD`
- [ ] 修改 `maxRetry` 使用 `UART4_OFFLINE_THRESHOLD`

**验证**: 从机需要连续5次超时才判定离线

---

## 任务4: 实现恢复滞后机制 [优先级: 中]

**文件**: `HARDWARE/modbus/modbus_uart4.c`

- [ ] 在 `uart4OnResponse` 中添加恢复计数逻辑
- [ ] 离线状态下收到响应时，先增加恢复计数
- [ ] 恢复计数达到 `UART4_RECOVER_THRESHOLD` 后才设为在线
- [ ] 在线状态下收到响应时，重置恢复计数

**验证**: 离线后需要连续2次成功响应才恢复在线

---

## 任务5: 编译验证 [优先级: 高]

- [ ] 使用 `UART4_POLL_COUNT=3` 编译
- [ ] 使用 `UART4_POLL_COUNT=5` 编译
- [ ] 使用 `UART4_POLL_COUNT=10` 编译
- [ ] 验证无编译错误和警告

---

## 任务6: 功能测试 [优先级: 高]

- [ ] 测试3台配置下的轮询行为
- [ ] 测试从机断电后的离线检测时间
- [ ] 测试从机上电后的恢复时间
- [ ] 验证状态不再频繁切换

---

## 依赖关系

```
任务1 ──┬──▶ 任务2
       │
       ├──▶ 任务3
       │
       └──▶ 任务4
              │
              ▼
           任务5 ──▶ 任务6
```

## 预计工时

| 任务 | 预计时间 |
|------|----------|
| 任务1 | 5分钟 |
| 任务2 | 10分钟 |
| 任务3 | 5分钟 |
| 任务4 | 15分钟 |
| 任务5 | 5分钟 |
| 任务6 | 用户测试 |
| **总计** | **40分钟** |


# 优化从机离线到待机状态恢复时间

## 问题描述

当前从机从离线状态恢复到待机状态的时间过长，影响用户体验和系统响应速度。

### 当前行为分析

1. **轮询配置**:
   - 轮询地址: 1-10 (共10个从机)
   - 响应超时: 500ms (`UART4_MASTER_TIMEOUT_DEFAULT_MS`)
   - 轮询间隔: 250ms (`UART4_MASTER_INTERVAL_DEFAULT_MS`)
   - 最大重试: 20次 (`maxRetry`)

2. **离线判定**:
   - `Send_Flag > 20` 时判定为离线
   - 每次超时 `Send_Flag++`

3. **状态恢复**:
   - 收到响应时 `Send_Flag = 0`, `Alive_Flag = OK`
   - 但 `Device_State` 需要根据响应数据更新

### 延迟计算

**最坏情况 (所有10个从机都离线)**:
- 单个从机超时: 500ms
- 10个从机一轮: 500ms × 10 = 5秒
- 加上轮询间隔: (500ms + 250ms) × 10 = 7.5秒

**从机恢复延迟**:
- 假设从机在轮询周期中间恢复
- 平均等待时间: 7.5秒 / 2 = 3.75秒
- 实际可能更长，因为需要等待下一轮轮询

## 优化方案

### 方案1: 减少超时时间 (推荐)

将响应超时从500ms减少到100ms。

**理由**:
- 从日志看 `elapsed=0ms` 或 `1ms`，实际响应非常快
- 100ms足够覆盖正常通信延迟
- 可大幅减少离线从机的等待时间

**效果**:
- 单轮时间: (100ms + 250ms) × 10 = 3.5秒 → 减少53%

### 方案2: 动态轮询间隔

对在线从机使用短间隔，对离线从机使用长间隔。

```c
/* 在线从机: 快速轮询 */
if (SlaveG[addr].Alive_Flag) {
    pollInterval = 100ms;
} else {
    /* 离线从机: 慢速探测 */
    pollInterval = 500ms;
}
```

### 方案3: 优先轮询在线从机

修改轮询顺序，优先轮询在线从机，离线从机放到队列末尾。

### 方案4: 快速恢复检测

当从机恢复时，立即更新状态，不等待下一轮完整轮询。

```c
static void uart4OnResponse(uint8_t slaveAddr, ...)
{
    /* 立即恢复状态 */
    SlaveG[addr].Send_Flag = 0;
    SlaveG[addr].Alive_Flag = OK;
    
    /* 如果之前是离线状态，立即更新为待机 */
    if (JiZu[addr].Slave_D.Device_State == 0) {
        JiZu[addr].Slave_D.Device_State = 1;  /* 待机 */
    }
    /* 后续根据数据更新具体状态 */
}
```

## 推荐实施

### 第一阶段 (立即实施)

1. 减少响应超时: 500ms → 100ms
2. 减少轮询间隔: 250ms → 100ms (或使用动态间隔0)
3. 优化响应回调，立即恢复状态

### 第二阶段 (可选)

1. 实现动态轮询间隔
2. 实现优先轮询在线从机

## 配置参数修改

```c
/* 修改前 */
#define UART4_MASTER_TIMEOUT_DEFAULT_MS   500U
#define UART4_MASTER_INTERVAL_DEFAULT_MS  250U

/* 修改后 */
#define UART4_MASTER_TIMEOUT_DEFAULT_MS   100U
#define UART4_MASTER_INTERVAL_DEFAULT_MS  0U  /* 动态间隔 */
```

## 风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 超时时间过短 | 误判在线为离线 | 保留100ms余量，观察实际响应时间 |
| 轮询过快 | 总线冲突 | 使用动态间隔，收到响应后立即切换 |
| 兼容性问题 | 旧从机响应慢 | 可配置超时时间，按需调整 |

## 预期效果

| 指标 | 修改前 | 修改后 | 改善 |
|------|--------|--------|------|
| 单轮时间 | 7.5秒 | 1秒 | -87% |
| 平均恢复时间 | 3.75秒 | 0.5秒 | -87% |
| 最大恢复时间 | 7.5秒 | 1秒 | -87% |

## 实施文件

- `HARDWARE/modbus/modbus_uart4.c`: 修改超时和间隔配置
- `HARDWARE/modbus/modbus_master.c`: 可选优化轮询逻辑


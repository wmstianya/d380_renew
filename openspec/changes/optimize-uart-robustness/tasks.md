# Tasks: UART通信健壮性与可维护性优化

## Phase 1: 错误恢复机制 ⬜ (高优先级)

### 1.1 UART驱动层错误处理
- [ ] 1.1.1 在`UartHandle`中添加错误计数器
- [ ] 1.1.2 实现`uartErrorHandler()`函数
- [ ] 1.1.3 在IDLE中断中调用错误检查
- [ ] 1.1.4 实现`uartDmaRxReinit()`重新初始化函数

### 1.2 错误标志检测
- [ ] 1.2.1 检测DMA传输错误(TE)
- [ ] 1.2.2 检测UART溢出错误(ORE)
- [ ] 1.2.3 检测帧错误(FE)
- [ ] 1.2.4 检测噪声错误(NE)

---

## Phase 2: 通信统计与诊断 ⬜ (中优先级)

### 2.1 统计结构定义
- [ ] 2.1.1 定义`UartStats`结构体
- [ ] 2.1.2 在`UartHandle`中集成统计字段
- [ ] 2.1.3 添加统计重置函数

### 2.2 统计更新
- [ ] 2.2.1 发送完成时增加`txFrames`
- [ ] 2.2.2 接收完成时增加`rxFrames`
- [ ] 2.2.3 CRC错误时增加`crcErrors`
- [ ] 2.2.4 超时时增加`timeouts`

### 2.3 诊断接口
- [ ] 2.3.1 实现`uartGetStats()`获取统计
- [ ] 2.3.2 可选: 通过ModBus暴露统计数据

---

## Phase 3: 看门狗集成 ⬜ (高优先级)

### 3.1 活动监控
- [ ] 3.1.1 在`ModbusHandle`中添加`lastActivityMs`
- [ ] 3.1.2 每次收发时更新活动时间戳
- [ ] 3.1.3 实现`modbusCheckActivity()`

### 3.2 超时处理
- [ ] 3.2.1 定义活动超时阈值(30秒)
- [ ] 3.2.2 超时时记录告警
- [ ] 3.2.3 可选: 超时触发系统复位

---

## Phase 4: 上电通信故障修复 ⬜ (中优先级)

### 4.1 修改上电自检循环
- [ ] 4.1.1 在`while(sys_flag.Check_Finsh)`中添加ModBus调度
- [ ] 4.1.2 验证屏幕上电无"通讯故障"显示
- [ ] 4.1.3 确保自检功能不受影响

---

## Phase 5: 内存优化 ⬜ (低优先级)

### 5.1 缓冲区大小调整
- [ ] 5.1.1 分析各UART实际最大帧长度
- [ ] 5.1.2 定义差异化缓冲区大小宏
- [ ] 5.1.3 修改初始化函数使用新大小

### 5.2 验证测试
- [ ] 5.2.1 测试USART2屏幕通信(最大帧)
- [ ] 5.2.2 测试UART4联控通信
- [ ] 5.2.3 压力测试无数据丢失

---

## Phase 6: Flash磨损保护 ⬜ (低优先级)

### 6.1 Flash管理模块
- [ ] 6.1.1 创建`flash_manager.h/c`
- [ ] 6.1.2 实现延迟写入机制(5秒)
- [ ] 6.1.3 实现每日写入限制

### 6.2 集成
- [ ] 6.2.1 修改`Write_Admin_Flash()`调用点
- [ ] 6.2.2 在主循环添加`flashWriteScheduler()`
- [ ] 6.2.3 测试参数保存功能正常

---

## 实施顺序建议

```
Phase 4 (0.5h) → Phase 1 (2h) → Phase 3 (1h) → Phase 2 (2h) → Phase 5 (1h) → Phase 6 (4h)
   ↓               ↓              ↓              ↓              ↓              ↓
 快速见效       核心稳定性      防止假死       诊断能力      节省内存      长期可靠
```

## 验收标准

- [ ] 所有Phase编译0错误0警告
- [ ] Phase 4: 上电屏幕无"通讯故障"
- [ ] Phase 1: 模拟DMA错误能自动恢复
- [ ] Phase 2: 能查询通信统计数据
- [ ] Phase 5: RAM占用减少>50%
- [ ] Phase 6: 参数修改后5秒内不立即写Flash


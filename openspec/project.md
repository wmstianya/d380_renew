# Project Context

## Purpose
这是一个基于 STM32F103 微控制器的工业燃气锅炉/蒸汽发生器控制系统固件项目。系统实现点火逻辑控制、多传感器监测、安全保护、多机联控等功能，用于工业级燃气蒸汽发生设备的自动化控制。

**核心功能：**
- 自动点火控制（前吹扫、点火、后吹扫）
- 多传感器实时监测（温度、压力、水位、燃气压力、火焰）
- 安全保护逻辑（23种报警类型）
- 风机变频控制（PID调节）
- 继电器输出控制（燃气阀、水泵、风机等）
- 多机联动控制（主从机通信）
- LCD人机交互界面
- ModBus通信支持

## Tech Stack

### 硬件平台
- **MCU**: STM32F103VC (ARM Cortex-M3, 72MHz)
- **时钟**: 外部晶振 12MHz, PLL 倍频至 72MHz
- **Flash**: 256KB
- **RAM**: 48KB

### 核心外设
- **ADC**: 内部ADC + 外部ADS1220 (24位高精度ADC)
- **UART**: 5个串口 (RS485通信、LCD通信、内部通信、备用)
- **Timer**: TIM2-TIM5 (定时器、PWM输出、捕获)
- **SPI**: 外部Flash存储 + ADS1220通信
- **GPIO**: 数字输入输出（传感器、继电器、LED）
- **IWDG**: 独立看门狗
- **RTC**: 实时时钟

### 开发工具链
- **IDE**: Keil MDK (uVision)
- **编译器**: ARM Compiler
- **调试器**: J-Link
- **固件库**: STM32F10x Standard Peripheral Library

## Project Conventions

### Code Style (遵循嵌入式编程规范)

**命名约定：**
- 变量/函数：camelCase（例如：`uartInit`, `gasLowPressure`）
- 宏定义/常量：全大写+下划线（例如：`GAS_ON`, `MAX_PRESSURE_SET`）
- 结构体类型：大写+下划线（例如：`SYS_INF`, `UART_DATA`）
- **严禁**使用数字后缀（例如：禁止 `uart1Init`，应使用 `uartMainInit`）

**文件组织：**
- 驱动代码：`HARDWARE/` 目录（按外设分类）
- 系统控制：`SYSTEM/` 目录（系统逻辑、Flash操作、RTC等）
- 用户代码：`USER/` 目录（main.c、中断处理、配置）
- 标准库：`STM32F10x_FWLib/` 目录

**代码规范：**
- 每个函数不超过 20 行（复杂功能拆分为子函数）
- 必须包含详细注释（处理流程、原理、边界情况）
- 禁止魔法数字（所有常量定义为宏或const）
- 全局变量默认 static（除非跨文件访问）
- 头文件使用 include guards

**函数文档：**
- 每个函数必须包含参数和返回值说明
- 使用 Doxygen 风格注释：`@brief`, `@param`, `@retval`

### Architecture Patterns

**分层架构：**
```
应用层 (Application Layer)
  ├─ system_control.c - 系统状态机、业务逻辑
  ├─ main.c - 主循环、任务调度
  
驱动层 (Driver Layer)
  ├─ bsp_relays.c - 继电器驱动
  ├─ bsp_adc.c - ADC采样驱动
  ├─ ADS1220.c - 外部ADC驱动
  ├─ usart*.c - 串口通信驱动
  ├─ timer.c - 定时器驱动
  
硬件抽象层 (HAL)
  └─ STM32F10x Standard Peripheral Library
```

**状态机设计：**
- 系统主状态：IDLE（待机）、WORK（运行）、ALARM（报警）、MANUAL（手动）、CLEAN_MODE（清洗）
- 点火流程：前吹扫 → 点火 → 火焰检测 → 后吹扫
- 每个状态有独立的处理函数

**安全设计原则：**
- 所有延时必须有超时机制（避免 while(1) 死循环）
- 关键操作前检查前置条件
- 故障检测采用多重确认（防抖动）
- 看门狗定时喂狗
- 断电数据保护（Flash存储）

### Testing Strategy

**当前测试方法：**
- 单元测试：关键功能模块（建议使用 Unity/CMock）
- 集成测试：硬件在环测试（HIL）
- 现场调试：串口日志输出
- 长期稳定性测试

**测试要求：**
- 每个API接口需要有参数边界测试
- 安全保护逻辑必须测试所有分支
- 传感器输入需要模拟异常值测试

### Git Workflow

**版本控制：**
- 版本号格式：V1.0.X（记录在 `main.c` 文件头）
- 每次修改需在文件头添加修改记录（日期 + 版本 + 修改内容）

**当前版本：** V1.0.8 (2025-05-19)

**版本历史示例：**
```
V1.0.1 - 2025-03-25 - 正式使用
V1.0.2 - 2025-04-03 - 修复风机转速为10000转
V1.0.3 - 2025-04-03 - 修改手动模式功能控制逻辑
V1.0.8 - 2025-05-19 - 解决传感器温度保护问题
```

## Domain Context

### 工业锅炉控制领域知识

**燃烧控制流程：**
1. **前吹扫**：开启风机，吹扫燃烧室残留燃气（安全要求）
2. **点火准备**：检查水位、燃气压力、风机状态
3. **点火**：打开点火器+燃气阀，点燃燃气
4. **火焰检测**：确认火焰信号（失败则重试，最多3次）
5. **正常运行**：PID控制风机转速，维持目标压力
6. **停炉**：关闭燃气阀，后吹扫（清除残余燃气）

**安全保护体系（23种报警类型）：**
- Error3_LowGas：燃气压力低报警
- Error5_LowWater：缺水位报警
- Error11_DianHuo_Bad：点火失败
- Error12_FlameLose：运行中火焰熄灭
- 其他：压变保护、热保护、温度超限等

**传感器类型：**
- 温度传感器：炉本体温度、回水温度、排烟温度
- 压力传感器：蒸汽压力（压变+遥控）
- 水位传感器：极低水位、低水位、中水位、高水位
- 开关量输入：燃气压力开关、风压开关、火焰探测器

**执行器控制：**
- 燃气阀：开/关控制
- 风机：变频控制（0-100%）
- 水泵：开/关控制
- 排污阀：定时排污

## Important Constraints

### 技术约束
- **实时性要求**：传感器采样周期 ≤ 100ms
- **响应时间**：故障检测响应 ≤ 1s
- **看门狗超时**：约 3.7秒（IWDG_Prescaler_64, 900）
- **Flash写入次数**：参数存储需考虑Flash寿命
- **通信速率**：UART 9600/19200 bps

### 安全规范约束
- **燃气安全**：点火失败必须前吹扫
- **缺水保护**：极低水位立即停炉
- **过压保护**：压力超限自动停炉
- **火焰监测**：运行中火焰熄灭立即关闭燃气阀
- **看门狗**：必须使能，防止程序跑飞

### 业务约束
- 支持主从机模式（1主机 + 最多5从机）
- ModBus地址可配置（通过拨码开关）
- 参数断电保持（存储到内部或外部Flash）
- LCD显示协议兼容性

## External Dependencies

### 硬件依赖
- **ADS1220**: 24位高精度ADC芯片（SPI接口）
- **USR-C210**: WiFi模块（可选，用于远程监控）
- **外部Flash**: SPI Flash（参数存储、日志记录）
- **LCD触摸屏**: 串口屏（人机交互）

### 通信协议
- **ModBus RTU**: 主从机通信协议
- **自定义协议**: LCD通信协议
- **RS485**: 物理层总线

### 标准库依赖
- STM32F10x Standard Peripheral Library v3.5.0

### 开发依赖
- Keil MDK 5.x
- J-Link驱动

## 项目目录说明

```
UART/
├── CORE/                    # Cortex-M3核心文件、启动文件
├── HARDWARE/                # 硬件驱动层
│   ├── ADC/                 # 内部ADC驱动
│   ├── ADS1220/             # 外部24位ADC驱动
│   ├── led/                 # LED指示灯
│   ├── Parallel_Serial/     # 并串转换（输入检测）
│   ├── PWM/                 # PWM输出控制
│   ├── relays/              # 继电器驱动
│   ├── timers/              # 定时器驱动
│   ├── USART2-5/            # 串口驱动
│   └── USR_C210/            # WiFi模块驱动
├── SYSTEM/                  # 系统层
│   ├── system_control/      # 核心控制逻辑（状态机、业务逻辑）
│   ├── activate_key/        # 激活密钥管理
│   ├── delay/               # 延时函数
│   ├── in_flash/            # 内部Flash操作
│   ├── out_flash/           # 外部Flash操作
│   ├── rtc/                 # 实时时钟
│   └── iwdg/                # 看门狗
├── USER/                    # 用户代码
│   ├── main.c               # 主程序入口
│   ├── stm32f10x_it.c       # 中断处理函数
│   └── systick/             # 系统滴答
├── STM32F10x_FWLib/         # ST标准外设库
└── OBJ/                     # 编译输出目录
```
